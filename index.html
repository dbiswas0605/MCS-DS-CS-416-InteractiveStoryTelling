<!DOCTYPE html>
<html lang = "en">
   <head>
      <!-- <script src="https://d3js.org/d3.v7.min.js"></script> -->
      <script src="https://d3js.org/d3.v4.js"></script>
   </head>

   <body onload = 'init()'>
      <div id="my_dataviz"></div>
      
      <script>

      // set the dimensions and margins of the graph
      var margin = {top: 50, right: 30, bottom: 30, left: 100},
      width = 1200 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;


      // append the svg object to the body of the page
      var svg = d3.select("#my_dataviz")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform",
         "translate(" + margin.left + "," + margin.top + ")");

         let arrYears = new Array ();
         let arrOilEmission = new Array();
         let arrFlarEmission = new Array();
         let arrCementEmission = new Array();
         let arrCoalEmission = new Array();
         let arrGasEmission = new Array();
         let arrOtherEmission = new Array();

         let arrData = new Array();

         async function init()
         {
            await d3.csv("./Data/co2-emissions-by-fuel-line.csv", 
               function(consdata) {
                  if (consdata["Entity"] == "World") 
                  { 
                     // arrYears.push(consdata.Year);
                     // arrOilEmission.push(consdata['CO2 emissions from oil']);
                     // arrFlarEmission.push(consdata['CO2 emissions from flaring']);
                     // arrCementEmission.push(consdata['CO2 emissions from cement']);
                     // arrCoalEmission.push(consdata['CO2 emissions from coal']);
                     // arrGasEmission.push(consdata['CO2 emissions from gas']);
                     // arrOtherEmission.push(consdata['CO2 emissions from other industry']);

                     var dtOil = { date : d3.timeParse("%Y")(consdata.Year), value : consdata['CO2 emissions from oil'] };
                     arrOilEmission.push(dtOil);

                     var dtFlar = { date : d3.timeParse("%Y")(consdata.Year), value : consdata['CO2 emissions from flaring'] };
                     arrFlarEmission.push(dtFlar);

                     var dtCement = { date : d3.timeParse("%Y")(consdata.Year), value : consdata['CO2 emissions from cement'] };
                     arrCementEmission.push(dtCement);                     

                     var dtCoal = { date : d3.timeParse("%Y")(consdata.Year), value : consdata['CO2 emissions from coal'] };
                     arrCoalEmission.push(dtCoal);

                     var dtGas = { date : d3.timeParse("%Y")(consdata.Year), value : consdata['CO2 emissions from gas'] };
                     arrGasEmission.push(dtGas);
                     
                     var dtOther = { date : d3.timeParse("%Y")(consdata.Year), value : consdata['CO2 emissions from other industry'] };
                     arrOtherEmission.push(dtOther);                     

                     return { date : d3.timeParse("%Y")(consdata.Year), value : consdata['CO2 emissions from oil'] }
                  } 
            },
            
            function(data)
            {

            // Add X axis --> it is a date format
            var x = d3.scaleTime()
               .domain(d3.extent(data, function(d) { return d.date; }))
               .range([ 0, width ]);
            svg.append("g")
               .attr("transform", "translate(0," + height + ")")
               .call(d3.axisBottom(x));

            // Add Y axis
            var y = d3.scaleLinear()
               .domain([0, d3.max(data, function(d) { return +d.value; })])
               .range([ height, 0 ]);
            svg.append("g")
               .call(d3.axisLeft(y));
            


         // This allows to find the closest X index of the mouse:
         var bisect = d3.bisector(function(d) { return d.x; }).left;


         // Create the circle that travels along the curve of chart
         var focus = svg
            .append('g')
            .append('circle')
               .style("fill", "none")
               .attr("stroke", "black")
               .attr('r', 8.5)
               .style("opacity", 0)

         // Create the text that travels along the curve of chart
         var focusText = svg
            .append('g')
            .append('text')
               .style("opacity", 0)
               .attr("text-anchor", "left")
               .attr("alignment-baseline", "middle")


             // Add the line
             svg.append("path")
                .datum(arrOilEmission)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                .x(function(d) { return x(d.date) })
                .y(function(d) { return y(d.value) })
                )            

                svg.append("path")
                .datum(arrCoalEmission)
                .attr("fill", "none")
                .attr("stroke", "red")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                .x(function(d) { return x(d.date) })
                .y(function(d) { return y(d.value) })
                )  


                svg.append("path")
                .datum(arrCementEmission)
                .attr("fill", "none")
                .attr("stroke", "purple")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                .x(function(d) { return x(d.date) })
                .y(function(d) { return y(d.value) })
                )  


                svg.append("path")
                .datum(arrFlarEmission)
                .attr("fill", "none")
                .attr("stroke", "olive")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                .x(function(d) { return x(d.date) })
                .y(function(d) { return y(d.value) })
                )  

                svg.append("path")
                .datum(arrGasEmission)
                .attr("fill", "none")
                .attr("stroke", "green")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                .x(function(d) { return x(d.date) })
                .y(function(d) { return y(d.value) })
                )  

                svg.append("path")
                .datum(arrOtherEmission)
                .attr("fill", "none")
                .attr("stroke", "magenta")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                .x(function(d) { return x(d.date) })
                .y(function(d) { return y(d.value) })
                )  


            // Create a rect on top of the svg area: this rectangle recovers mouse position
            svg
               .append('rect')
               .style("fill", "none")
               .style("pointer-events", "all")
               .attr('width', width)
               .attr('height', height)
               .on('mouseover', mouseover)
               .on('mousemove', mousemove)
               .on('mouseout', mouseout);

  // What happens when the mouse move -> show the annotations at the right positions.
  function mouseover() {
    focus.style("opacity", 1)
    focusText.style("opacity",1)
  }

  function mousemove() {
    // recover coordinate we need
    var x0 = x.invert(d3.mouse(this)[0]);
    var i = bisect(data, x0, 1);
    console.log(data[i])
    selectedData = data[i]
    focus
      .attr("cx", x(selectedData.x))
      .attr("cy", y(selectedData.y))
    focusText
      .html("x:" + selectedData.value + "  -  " + "y:" + selectedData.value)
      .attr("x", x(selectedData.x)+15)
      .attr("y", y(selectedData.y))
    }
  function mouseout() {
    focus.style("opacity", 0)
    focusText.style("opacity", 0)
  }


               });
 
            // console.log('------------');
            // console.log(arrYears[arrYears.length -1]);
            // console.log(arrOilEmission[arrOilEmission.length -1]);
            // console.log(arrFlarEmission[arrFlarEmission.length -1]);
            // console.log(arrCementEmission[arrCementEmission.length -1]);
            // console.log(arrCoalEmission[arrCoalEmission.length -1]);
            // console.log(arrGasEmission[arrGasEmission.length -1]);
            // console.log(arrOtherEmission[arrOtherEmission.length -1]);
            // console.log('------------');
         }
      </script>




      
   </body>
</html>